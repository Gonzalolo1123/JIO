{% extends 'jio_app/base_admin.html' %}

{% load static %}
{% load humanize %}

{% block title %}Estadísticas - JIO{% endblock %}

{% block extra_head %}

<link rel="stylesheet" href="{% static 'css/estadisticas.css' %}">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

{% endblock %}

{% block content %}

<div class="content">

  <!-- Dashboard de KPIs -->
  <div class="kpis-dashboard">
    <div class="dashboard-header">
      <h2 style="margin: 0; color: #2E7D32; font-size: 1.75rem;">Resumen de {{ mes_nombre|title }} {{ año_seleccionado }}</h2>
      <div class="period-selector">
        <a href="?year={{ año_anterior_nav }}&month={{ mes_anterior_nav }}" class="nav-btn-period prev-btn" title="Mes anterior">
          <i class="fas fa-chevron-left"></i>
        </a>
        <div class="period-selectors">
          <select id="mes-selector" class="month-year-selector">
            {% for num, nombre in meses_espanol.items %}
              <option value="{{ num }}" {% if num == mes_seleccionado %}selected{% endif %}>{{ nombre }}</option>
            {% endfor %}
          </select>
          <select id="año-selector" class="month-year-selector">
            {% for año in años_disponibles %}
              <option value="{{ año }}" {% if año == año_seleccionado %}selected{% endif %}>{{ año }}</option>
            {% endfor %}
          </select>
        </div>
        {% if puede_avanzar %}
        <a href="?year={{ año_siguiente_nav }}&month={{ mes_siguiente_nav }}" class="nav-btn-period next-btn" title="Mes siguiente">
          <i class="fas fa-chevron-right"></i>
        </a>
        {% else %}
        <span class="nav-btn-period next-btn disabled" title="No se puede avanzar más">
          <i class="fas fa-chevron-right"></i>
        </span>
        {% endif %}
      </div>
    </div>
    
    <div class="kpis-grid">
      <!-- Tarjeta: Reservas del Mes -->
      <div class="kpi-card">
        <div class="kpi-icon">
          <i class="fas fa-calendar-check"></i>
        </div>
        <div class="kpi-content">
          <div class="kpi-label">Reservas del Mes</div>
          <div class="kpi-value">{{ total_reservas_mes }}</div>
          <div class="kpi-change {% if crecimiento_reservas >= 0 %}positive{% else %}negative{% endif %}">
            <i class="fas fa-arrow-{% if crecimiento_reservas >= 0 %}up{% else %}down{% endif %}"></i>
            {{ crecimiento_reservas|floatformat:1 }}% vs {{ mes_anterior_nombre|title }} {{ año_anterior_num }}
          </div>
        </div>
      </div>

      <!-- Tarjeta: Ventas del Mes -->
      <div class="kpi-card">
        <div class="kpi-icon">
          <i class="fas fa-dollar-sign"></i>
        </div>
        <div class="kpi-content">
          <div class="kpi-label">Ventas del Mes</div>
          <div class="kpi-value">${{ ventas_mes_actual|floatformat:0|intcomma }}</div>
          <div class="kpi-change {% if crecimiento_ventas >= 0 %}positive{% else %}negative{% endif %}">
            <i class="fas fa-arrow-{% if crecimiento_ventas >= 0 %}up{% else %}down{% endif %}"></i>
            {{ crecimiento_ventas|floatformat:1 }}% vs {{ mes_anterior_nombre|title }} {{ año_anterior_num }}
          </div>
        </div>
      </div>

      <!-- Tarjeta: Clientes Nuevos vs Recurrentes -->
      <div class="kpi-card">
        <div class="kpi-icon">
          <i class="fas fa-users"></i>
        </div>
        <div class="kpi-content">
          <div class="kpi-label">Clientes del Mes</div>
          <div class="kpi-value">{{ total_clientes_mes }}</div>
          <div class="kpi-subtitle">
            <span style="color: #4CAF50;">{{ clientes_nuevos }} nuevos</span> | 
            <span style="color: #2196F3;">{{ clientes_recurrentes }} recurrentes</span>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Comparaciones Temporales -->
  <div class="section comparison-section">
    <h2>Comparaciones Temporales</h2>
    
    <div class="comparison-grid">
      <!-- Comparación Mes a Mes -->
      <div class="comparison-card">
        <h3>Comparación Mes a Mes</h3>
        <div class="comparison-item">
          <div class="comparison-label">Ventas</div>
          <div class="comparison-values">
            <div class="comparison-current">
              <span class="comparison-period">{{ mes_nombre|title }} {{ año_seleccionado }}:</span>
              <span class="comparison-amount">${{ ventas_mes_actual|floatformat:0|intcomma }}</span>
            </div>
            <div class="comparison-previous">
              <span class="comparison-period">{{ mes_anterior_nombre|title }} {{ año_anterior_num }}:</span>
              <span class="comparison-amount">${{ ventas_mes_anterior|floatformat:0|intcomma }}</span>
            </div>
            <div class="comparison-growth {% if crecimiento_ventas >= 0 %}positive{% else %}negative{% endif %}">
              <i class="fas fa-arrow-{% if crecimiento_ventas >= 0 %}up{% else %}down{% endif %}"></i>
              {{ crecimiento_ventas|floatformat:1 }}% de crecimiento
            </div>
          </div>
        </div>
        <div class="comparison-item">
          <div class="comparison-label">Reservas</div>
          <div class="comparison-values">
            <div class="comparison-current">
              <span class="comparison-period">{{ mes_nombre|title }} {{ año_seleccionado }}:</span>
              <span class="comparison-amount">{{ total_reservas_mes }}</span>
            </div>
            <div class="comparison-previous">
              <span class="comparison-period">{{ mes_anterior_nombre|title }} {{ año_anterior_num }}:</span>
              <span class="comparison-amount">{{ total_reservas_mes_anterior }}</span>
            </div>
            <div class="comparison-growth {% if crecimiento_reservas >= 0 %}positive{% else %}negative{% endif %}">
              <i class="fas fa-arrow-{% if crecimiento_reservas >= 0 %}up{% else %}down{% endif %}"></i>
              {{ crecimiento_reservas|floatformat:1 }}% de crecimiento
            </div>
          </div>
        </div>
      </div>

      <!-- Comparación Año a Año -->
      <div class="comparison-card">
        <h3>Comparación Año a Año</h3>
        <div class="comparison-item">
          <div class="comparison-label">Ventas</div>
          <div class="comparison-values">
            <div class="comparison-current">
              <span class="comparison-period">{{ año_seleccionado }}:</span>
              <span class="comparison-amount">${{ ventas_año_actual|floatformat:0|intcomma }}</span>
            </div>
            <div class="comparison-previous">
              <span class="comparison-period">{{ año_seleccionado|add:"-1" }}:</span>
              <span class="comparison-amount">${{ ventas_año_anterior|floatformat:0|intcomma }}</span>
            </div>
            <div class="comparison-growth {% if crecimiento_año >= 0 %}positive{% else %}negative{% endif %}">
              <i class="fas fa-arrow-{% if crecimiento_año >= 0 %}up{% else %}down{% endif %}"></i>
              {{ crecimiento_año|floatformat:1 }}% de crecimiento
            </div>
          </div>
        </div>
        <div class="comparison-item">
          <div class="comparison-label">Reservas</div>
          <div class="comparison-values">
            <div class="comparison-current">
              <span class="comparison-period">{{ año_seleccionado }}:</span>
              <span class="comparison-amount">{{ reservas_año_actual }}</span>
            </div>
            <div class="comparison-previous">
              <span class="comparison-period">{{ año_seleccionado|add:"-1" }}:</span>
              <span class="comparison-amount">{{ reservas_año_anterior }}</span>
            </div>
            <div class="comparison-growth {% if crecimiento_reservas_año >= 0 %}positive{% else %}negative{% endif %}">
              <i class="fas fa-arrow-{% if crecimiento_reservas_año >= 0 %}up{% else %}down{% endif %}"></i>
              {{ crecimiento_reservas_año|floatformat:1 }}% de crecimiento
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="button-group" id="view-mode-group">

    <label>Vista de gráficos:</label>

    <button type="button" id="btn-small" class="view-mode-btn">Pequeño</button>

    <button type="button" id="btn-medium" class="view-mode-btn active">Mediano</button>

    <button type="button" id="btn-large" class="view-mode-btn">Grande</button>

  </div>

  <!-- Sección de Ventas -->

  <div class="section">

    <h2>Ventas</h2>

    <div class="button-group" id="time-filter">

      <button onclick="updateMoneyChart('weekly', this)">Semanal</button>

      <button onclick="updateMoneyChart('monthly', this)">Mensual</button>

      <button onclick="updateMoneyChart('yearly', this)">Anual</button>

    </div>

    <div class="chart-container">
      <canvas id="moneyChart"></canvas>
    </div>

  </div>

    <!-- Sección de Ventas por Categoría de Juego -->

    <div class="section">

      <h2>Ventas por categoría de juego</h2>

      <div class="button-group" id="category-filter">

        <button onclick="setCategoryPeriod('weekly', this)">Semanal</button>

        <button onclick="setCategoryPeriod('monthly', this)">Mensual</button>

        <button onclick="setCategoryPeriod('yearly', this)">Anual</button>

      </div>

    <div class="chart-container">
      <canvas id="categoryChart"></canvas>
    </div>

  </div>

    <!-- Sección de Días con Mayor Demanda de Reservas -->

    <div class="section">

      <h2>Días con mayor demanda de reservas</h2>

      <div class="button-group" id="days-filter">

        <button onclick="updateDaysChart('weekly', this)">Semanal</button>

        <button onclick="updateDaysChart('monthly', this)">Mensual</button>

        <button onclick="updateDaysChart('yearly', this)">Anual</button>

      </div>

    <div class="chart-container">
      <canvas id="daysChart"></canvas>
    </div>

  </div>

</div>

<!-- Datos ocultos para JavaScript -->

<!-- Datos de ventas -->

<div id="ventas-semanales-labels" style="display: none;">{{ ventas_semanales_labels|safe }}</div>

<div id="ventas-semanales-data" style="display: none;">{{ ventas_semanales_data|safe }}</div>

<div id="ventas-mensuales-labels" style="display: none;">{{ ventas_mensuales_labels|safe }}</div>

<div id="ventas-mensuales-data" style="display: none;">{{ ventas_mensuales_data|safe }}</div>

<div id="ventas-anuales-labels" style="display: none;">{{ ventas_anuales_labels|safe }}</div>

<div id="ventas-anuales-data" style="display: none;">{{ ventas_anuales_data|safe }}</div>

<!-- Datos de ventas por categoría -->

<div id="ventas-categoria-diarias-data" style="display: none;">{{ ventas_categoria_diarias_data|safe }}</div>

<div id="ventas-categoria-semanales-data" style="display: none;">{{ ventas_categoria_semanales_data|safe }}</div>

<div id="ventas-categoria-mensuales-data" style="display: none;">{{ ventas_categoria_mensuales_data|safe }}</div>

<div id="ventas-categoria-anuales-data" style="display: none;">{{ ventas_categoria_anuales_data|safe }}</div>

<div id="categorias-unicas" style="display: none;">{{ categorias_unicas|safe }}</div>

<!-- Datos de días con mayor demanda de reservas -->

<div id="dias-semana-semanales-labels" style="display: none;">{{ dias_semana_semanales_labels|safe }}</div>

<div id="dias-semana-semanales-data" style="display: none;">{{ dias_semana_semanales_data|safe }}</div>

<div id="dias-semana-mensuales-labels" style="display: none;">{{ dias_semana_mensuales_labels|safe }}</div>

<div id="dias-semana-mensuales-data" style="display: none;">{{ dias_semana_mensuales_data|safe }}</div>

<div id="dias-semana-anuales-labels" style="display: none;">{{ dias_semana_anuales_labels|safe }}</div>

<div id="dias-semana-anuales-data" style="display: none;">{{ dias_semana_anuales_data|safe }}</div>

{% endblock %}

{% block extra_scripts %}

<script src="{% static 'js/estadisticas.js' %}"></script>
<script>
  // Navegación de mes/año con selectores
  document.addEventListener('DOMContentLoaded', function() {
    const mesSelector = document.getElementById('mes-selector');
    const añoSelector = document.getElementById('año-selector');
    
    function navegarPeriodo() {
      const mes = mesSelector.value;
      const año = añoSelector.value;
      window.location.href = `?year=${año}&month=${mes}`;
    }
    
    if (mesSelector) {
      mesSelector.addEventListener('change', navegarPeriodo);
    }
    
    if (añoSelector) {
      añoSelector.addEventListener('change', navegarPeriodo);
    }
  });
</script>

{% endblock %}

