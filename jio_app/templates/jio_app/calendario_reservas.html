{% extends "jio_app/base.html" %}
{% load static %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/calendario.css' %}">
<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- Leaflet CSS para el mapa -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<style>
  .pac-container {
    z-index: 10000 !important;
  }
  #direccion {
    width: 100%;
    padding: 10px;
    border: 2px solid #ddd;
    border-radius: 5px;
    font-size: 1rem;
    transition: border-color 0.3s;
  }
  #direccion:focus {
    outline: none;
    border-color: #2c5530;
  }
  .direccion-autocomplete-wrapper {
    position: relative !important;
    width: 100%;
    z-index: 1;
    overflow: visible !important;
  }
  
  .form-group {
    overflow: visible !important;
  }
  
  .modal-reserva-body {
    overflow: visible !important;
  }
  
  /* Grid para el formulario */
  #formulario-reserva {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
  }
  
  #formulario-reserva .form-group {
    display: flex;
    flex-direction: column;
  }
  
  #formulario-reserva label {
    margin-bottom: 0.5rem;
    font-weight: 500;
    color: #333;
  }
  
  #formulario-reserva input[type="text"],
  #formulario-reserva input[type="email"],
  #formulario-reserva input[type="tel"],
  #formulario-reserva input[type="time"],
  #formulario-reserva input[type="number"],
  #formulario-reserva select,
  #formulario-reserva textarea {
    padding: 0.75rem;
    border: 2px solid #ddd;
    border-radius: 4px;
    font-size: 1rem;
    transition: border-color 0.3s;
  }
  
  #formulario-reserva input:focus,
  #formulario-reserva select:focus,
  #formulario-reserva textarea:focus {
    outline: none;
    border-color: #2c5530;
  }
  
  /* Estilos para filas de juegos */
  .juego-row {
    display: grid;
    grid-template-columns: 1fr auto auto;
    gap: 0.75rem;
    align-items: center;
    padding: 0.75rem;
    background: #f9f9f9;
    border-radius: 8px;
    border: 1px solid #ddd;
  }
  
  .juego-row .juego-select {
    padding: 0.75rem;
    border: 2px solid #ddd;
    border-radius: 4px;
    font-size: 1rem;
  }
  
  /* Estilos para opciones de juegos en el select */
  .juego-row .juego-select option.juego-disponible {
    color: #000;
    background-color: #fff;
  }
  
  .juego-row .juego-select option.juego-ocupado {
    color: #d32f2f !important;
    background-color: #fff5f5 !important;
    font-style: italic !important;
  }
  
  .juego-row .juego-select option:disabled.juego-ocupado {
    color: #d32f2f !important;
    background-color: #fff5f5 !important;
    font-style: italic !important;
    cursor: not-allowed !important;
  }
  
  .juego-row .juego-select option:disabled:not(.juego-ocupado) {
    color: #ccc !important;
    background-color: #f5f5f5 !important;
    font-size: 0.85rem !important;
  }
  
  .juego-row .juego-precio {
    padding: 0.75rem;
    font-weight: 600;
    color: #2c5530;
    text-align: right;
    min-width: 100px;
  }
  
  .juego-row .btn-remove-juego {
    padding: 0;
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 32px;
    transition: all 0.2s ease;
  }
  
  .juego-row .btn-remove-juego:hover {
    background: #c82333;
    transform: scale(1.1);
  }
  
  .juego-row .btn-remove-juego i {
    font-size: 1rem;
    font-weight: bold;
    color: white;
    line-height: 1;
  }
  
  /* Si FontAwesome no est√° disponible, mostrar texto X */
  .juego-row .btn-remove-juego:not(:has(i))::before {
    content: '√ó';
    font-size: 1.5rem;
    font-weight: bold;
    color: white;
    line-height: 1;
  }
  
  .form-actions {
    grid-column: 1 / -1;
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid #ddd;
  }
  
  .direccion-search-container {
    position: relative;
    width: 100%;
  }
  
  /* Estilos para el autocompletado */
  .autocomplete-suggestions {
    position: absolute !important;
    top: calc(100% + 4px) !important;
    left: 0 !important;
    width: calc(100% - 54px) !important;
    background: white !important;
    border: 2px solid #2c5530 !important;
    border-radius: 8px !important;
    max-height: 300px !important;
    overflow-y: auto !important;
    z-index: 10001 !important;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2) !important;
    margin-top: 0 !important;
    display: none;
    visibility: visible;
    opacity: 1;
  }
  
  .autocomplete-suggestion {
    padding: 12px 15px;
    cursor: pointer;
    border-bottom: 1px solid #e0e0e0;
    transition: background-color 0.2s;
    display: flex;
    align-items: center;
    gap: 10px;
    min-height: 50px;
  }
  
  .autocomplete-suggestion:first-child {
    border-top-left-radius: 8px;
    border-top-right-radius: 8px;
  }
  
  .autocomplete-suggestion:last-child {
    border-bottom: none;
    border-bottom-left-radius: 8px;
    border-bottom-right-radius: 8px;
  }
  
  .autocomplete-suggestion:hover,
  .autocomplete-suggestion.selected {
    background-color: #e8f5e9;
  }
  
  .autocomplete-suggestion:active {
    background-color: #c8e6c9;
  }
  
  .autocomplete-suggestion-icon {
    font-size: 1.2rem;
    color: #2c5530;
    flex-shrink: 0;
  }
  
  .autocomplete-suggestion-text {
    flex: 1;
    font-size: 0.95rem;
    color: #333;
  }
  
  .autocomplete-suggestion-text strong {
    color: #2c5530;
    font-weight: 600;
  }
  
  .autocomplete-suggestion-type {
    font-size: 0.8rem;
    color: #666;
    font-style: italic;
  }
  
  .autocomplete-loading {
    padding: 12px 15px;
    text-align: center;
    color: #666;
    font-style: italic;
  }
  .mapa-link-container {
    margin-top: 15px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    border: 2px solid #2c5530;
    text-align: center;
  }
  
  .mapa-link-btn {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    padding: 12px 24px;
    background: #2c5530;
    color: white;
    text-decoration: none;
    border-radius: 5px;
    font-weight: 600;
    transition: background 0.3s;
    border: none;
    cursor: pointer;
    font-size: 1rem;
  }
  
  .mapa-link-btn:hover {
    background: #1e3a21;
    color: white;
  }
  
  .mapa-link-btn:disabled {
    background: #ccc;
    cursor: not-allowed;
    opacity: 0.6;
  }
  
  .mapa-link-btn:not(:disabled) {
    background: #2c5530;
    cursor: pointer;
  }
  
  .mapa-link-container {
    visibility: visible !important;
    display: block !important;
    margin-top: 15px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    border: 2px solid #2c5530;
    text-align: center;
  }
  
  #abrir-google-maps {
    display: inline-flex !important;
    visibility: visible !important;
    opacity: 0.6;
  }
  
  #abrir-google-maps:not(:disabled) {
    opacity: 1 !important;
    background: #2c5530 !important;
    cursor: pointer !important;
  }
  
  /* Contenedor de b√∫squeda de direcci√≥n */
  .direccion-search-container {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
  }
  
  .direccion-search-container #direccion {
    flex: 1;
    padding: 12px;
    border: 2px solid #ddd;
    border-radius: 8px;
    font-size: 1rem;
    transition: border-color 0.3s;
  }
  
  .direccion-search-container #direccion:focus {
    outline: none;
    border-color: #2c5530;
  }
  
  .btn-buscar {
    padding: 12px 20px;
    background: #2c5530;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 600;
    transition: background 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    white-space: nowrap;
    min-width: auto;
  }
  
  .btn-buscar:hover {
    background: #1e3d21;
  }
  
  .btn-buscar:active {
    background: #153017;
    transform: scale(0.98);
  }
  
  /* Contenedor del mapa */
  .mapa-container {
    position: relative;
    width: 100%;
    height: 600px;
    margin-top: 15px;
    margin-bottom: 15px;
    border-radius: 8px;
    overflow: hidden;
    border: 2px solid #2c5530;
    background: #f0f0f0;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    display: block !important;
    visibility: visible !important;
  }
  
  .mapa-leaflet {
    width: 100%;
    height: 100%;
    z-index: 1;
    min-height: 600px;
  }
  
  .mapa-loading {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.9);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 10;
  }
  
  .spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #2c5530;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  /* Informaci√≥n de ubicaci√≥n seleccionada */
  .mapa-info-seleccionada {
    margin-top: 15px;
    padding: 15px;
    background: #e8f5e8;
    border-radius: 8px;
    border-left: 4px solid #2c5530;
  }
  
  .mapa-info-seleccionada .info-item {
    margin-bottom: 8px;
    font-size: 0.95rem;
  }
  
  .mapa-info-seleccionada .info-item:last-child {
    margin-bottom: 0;
  }
  
  .mapa-info-seleccionada strong {
    color: #2c5530;
    margin-right: 8px;
  }
  
  /* Bot√≥n de Google Maps */
  .mapa-link-container {
    margin-top: 10px;
    text-align: center;
  }
  
  .btn-google-maps {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    padding: 12px 24px;
    background: #2c5530;
    color: white;
    text-decoration: none;
    border-radius: 5px;
    font-weight: 600;
    border: none;
    cursor: pointer;
    font-size: 1rem;
    transition: all 0.3s;
  }
  
  .btn-google-maps:hover:not(:disabled) {
    background: #1e3d21;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
  }
  
  .btn-google-maps:disabled {
    background: #ccc;
    cursor: not-allowed;
    opacity: 0.6;
  }
  
  /* Estilos para el mapa Leaflet */
  .leaflet-container {
    font-family: 'Arial', sans-serif;
  }
  
  .leaflet-popup-content-wrapper {
    border-radius: 8px;
  }
  
  .leaflet-popup-content {
    margin: 15px;
    font-size: 0.95rem;
  }
  
  /* Estilos para juegos ocupados en el select */
  #juego {
    font-size: 1rem;
  }
  
  #juego option.juego-ocupado {
    color: #d32f2f !important;
    background-color: #ffebee !important;
    font-weight: 600 !important;
  }
  
  #juego option:disabled.juego-ocupado {
    color: #d32f2f !important;
    background-color: #ffebee !important;
    font-weight: 600 !important;
    cursor: not-allowed !important;
  }
  
  #juego option:disabled:not(.juego-ocupado) {
    color: #999 !important;
    background-color: #f5f5f5 !important;
    font-weight: bold !important;
  }
  
  /* Mejorar visibilidad en diferentes navegadores */
  #juego option {
    padding: 8px 12px;
  }
  
  #juego option.juego-ocupado,
  #juego option:disabled.juego-ocupado {
    color: #c62828 !important;
    background: linear-gradient(to right, #ffebee 0%, #ffcdd2 100%) !important;
    border-left: 3px solid #d32f2f !important;
    padding-left: 9px;
  }
</style>
{% endblock %}

{% block content %}
<div class="calendario-container">
  <div class="calendario-header">
    <h1>Calendario de Reservas</h1>
    <p>Selecciona una fecha para ver la disponibilidad y hacer tu reserva</p>
  </div>

  <div class="calendario-content">
    <!-- Controles del calendario -->
    <div class="calendario-controls">
      <button id="prev-month" class="btn-nav">&lt;</button>
      <h2 id="current-month"></h2>
      <button id="next-month" class="btn-nav">&gt;</button>
    </div>

    <!-- Calendario -->
    <div class="calendario-grid" id="calendario-grid">
      <!-- Los d√≠as se generar√°n din√°micamente con JavaScript -->
    </div>

    <!-- Informaci√≥n de disponibilidad -->
    <div class="disponibilidad-info">
      <h3>Informaci√≥n de Disponibilidad</h3>
      <div class="disponibilidad-legend">
        <div class="legend-item">
          <span class="legend-color disponible"></span>
          <span>Disponible</span>
        </div>
        <div class="legend-item">
          <span class="legend-color ocupado"></span>
          <span>Ocupado</span>
        </div>
        <div class="legend-item">
          <span class="legend-color pasado"></span>
          <span>Fecha pasada</span>
        </div>
      </div>
    </div>

    <!-- Modal de reserva (popup) -->
    <div class="modal-reserva" id="modal-reserva" style="display: none;">
      <div class="modal-reserva-overlay" id="modal-overlay"></div>
      <div class="modal-reserva-content">
        <div class="modal-reserva-header">
          <h3>Formulario de Reserva</h3>
          <button class="modal-close-btn" id="modal-close-btn">&times;</button>
        </div>
        <div class="modal-reserva-body">
          <p id="fecha-seleccionada" class="fecha-seleccionada-text"></p>
          
          <form id="formulario-reserva">
            <!-- Datos del Cliente -->
            <div class="form-group" style="grid-column: 1 / -1; margin-top: 0.5rem; margin-bottom: 0.25rem;">
              <strong style="font-size: 1.1rem; color: #2c5530;">Datos del Cliente *</strong>
            </div>
            
            <div class="form-group">
              <label for="nombre">Nombre *</label>
              <input type="text" id="nombre" name="nombre" required>
            </div>
            
            <div class="form-group">
              <label for="apellido">Apellido *</label>
              <input type="text" id="apellido" name="apellido" required>
            </div>
            
            <div class="form-group">
              <label for="email">Correo electr√≥nico *</label>
              <input type="email" id="email" name="email" required>
            </div>
            
            <div class="form-group">
              <label for="telefono">Tel√©fono</label>
              <input type="tel" id="telefono" name="telefono" placeholder="+56912345678">
            </div>

            <!-- Datos del Evento -->
            <div class="form-group" style="grid-column: 1 / -1; margin-top: 0.5rem; margin-bottom: 0.25rem;">
              <strong style="font-size: 1.1rem; color: #2c5530;">Datos del Evento</strong>
            </div>
            
            <div class="form-group">
              <label for="hora_instalacion">Hora Instalaci√≥n *</label>
              <input type="time" id="hora_instalacion" name="hora_instalacion" required>
            </div>
            
            <div class="form-group">
              <label for="hora_retiro">Hora Retiro *</label>
              <input type="time" id="hora_retiro" name="hora_retiro" required>
            </div>
            
            <div class="form-group">
              <label for="distancia_km">Distancia (km fuera de Osorno)</label>
              <input type="number" id="distancia_km" name="distancia_km" min="0" step="1" value="0" placeholder="0">
              <small class="form-help" style="display:block;color:#666;margin-top:0.25rem;">
                <i class="fas fa-info-circle"></i> $1.000 por kil√≥metro fuera de Osorno
              </small>
            </div>
            
            <div class="form-group">
              <span style="font-size:0.875rem;color:#666;">Precio por distancia: <span id="precio-distancia">$0</span></span>
            </div>
            
            <!-- Juegos -->
            <div class="form-group" style="grid-column: 1 / -1;">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem;">
                <label style="margin:0;"><strong>Juegos Disponibles *</strong></label>
                <button type="button" id="btn-add-juego" class="btn btn-secondary" style="padding:0.25rem 0.75rem;font-size:0.875rem;background:#2c5530;color:white;border:none;border-radius:4px;cursor:pointer;">
                  <i class="fas fa-plus"></i> Agregar Juego
                </button>
              </div>
              <div id="juegos-container" style="display:grid;gap:0.75rem;">
                <!-- Juegos se agregar√°n aqu√≠ din√°micamente -->
              </div>
              <div id="total-container" style="margin-top:1rem;padding:1rem;background:#fff3e0;border-radius:8px;display:none;">
                <div style="display:flex;justify-content:space-between;margin-bottom:0.5rem;">
                  <span>Subtotal Juegos:</span>
                  <span id="subtotal-juegos">$0</span>
                </div>
                <div style="display:flex;justify-content:space-between;margin-bottom:0.5rem;">
                  <span>Precio por Distancia:</span>
                  <span id="precio-distancia-total">$0</span>
                </div>
                <div style="border-top:1px solid #ccc;padding-top:0.5rem;display:flex;justify-content:space-between;">
                  <strong style="font-size:1.25rem;">Total:</strong>
                  <strong style="font-size:1.25rem;"><span id="total-reserva">$0</span></strong>
                </div>
              </div>
              <div id="info-juegos-ocupados" class="info-juegos-ocupados" style="display: none; margin-top: 8px; padding: 10px; background-color: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px; font-size: 0.9rem; color: #856404;">
                <strong>‚ÑπÔ∏è Nota:</strong> Los juegos marcados con ‚ùå en <span style="color: #c62828; font-weight: 600;">rojo</span> est√°n reservados y no est√°n disponibles para esta fecha.
              </div>
              <small style="color:#666;margin-top:0.5rem;display:block;">
                <i class="fas fa-info-circle"></i> Los juegos disponibles se actualizar√°n autom√°ticamente seg√∫n la fecha seleccionada.
              </small>
            </div>
            
            <input type="hidden" id="juegos-json" name="juegos" value="[]">
            
            <div class="form-group" style="grid-column: 1 / -1;">
              <label for="direccion">Direcci√≥n del evento:</label>
              
              <!-- Barra de b√∫squeda con bot√≥n -->
              <div class="direccion-autocomplete-wrapper">
                <div class="direccion-search-container">
                  <input type="text" id="direccion" name="direccion" placeholder="Busca una direcci√≥n con autocompletado..." required autocomplete="off">
                  <button type="button" id="btn-buscar-direccion" class="btn-buscar" title="Buscar en el mapa">
                    <span>üó∫Ô∏è</span> Buscar en el mapa
                  </button>
                </div>
                <!-- Dropdown de sugerencias de autocompletado -->
                <div id="autocomplete-suggestions" class="autocomplete-suggestions" style="display: none;"></div>
              </div>
              <small class="form-help">üí° Escribe una direcci√≥n (ej: "hueyusca 312") y aparecer√°n sugerencias de autocompletado. Tambi√©n puedes hacer clic en el mapa para seleccionar una ubicaci√≥n o usar el bot√≥n "Buscar en el mapa"</small>
              
              <!-- Campos ocultos para coordenadas -->
              <input type="hidden" id="direccion_lat" name="direccion_lat">
              <input type="hidden" id="direccion_lng" name="direccion_lng">
              <input type="hidden" id="direccion_completa" name="direccion_completa">
              
              <!-- Mapa interactivo -->
              <div id="mapa-container" class="mapa-container">
                <div id="mapa" class="mapa-leaflet"></div>
                <div class="mapa-loading" id="mapa-loading" style="display: none;">
                  <div class="spinner"></div>
                  <p>Cargando mapa...</p>
                </div>
              </div>
              
              <!-- Informaci√≥n de la ubicaci√≥n seleccionada -->
              <div class="mapa-info-seleccionada" id="mapa-info-seleccionada" style="display: none;">
                <div class="info-item">
                  <strong>üìç Ubicaci√≥n seleccionada:</strong>
                  <span id="direccion-seleccionada-text">-</span>
                </div>
                <div class="info-item">
                  <strong>üìè Distancia desde Osorno:</strong>
                  <span id="distancia-seleccionada-text">-</span>
                </div>
              </div>
              
              <!-- Bot√≥n para abrir en Google Maps -->
              <div class="mapa-link-container" id="mapa-link-container" style="display: none; margin-top: 10px; text-align: center;">
                <button type="button" id="abrir-google-maps" class="btn-google-maps" disabled>
                  <span>üó∫Ô∏è</span>
                  <span>Ver en Google Maps</span>
                </button>
              </div>
            </div>
            
            <div class="form-group" style="grid-column: 1 / -1;">
              <label for="observaciones">Observaciones</label>
              <textarea id="observaciones" name="observaciones" rows="3"></textarea>
            </div>
            
            <div id="form-errors" class="form-errors" style="display: none;"></div>
            
            <div class="form-actions">
              <button type="button" id="cancelar-reserva" class="btn-cancelar">Cancelar</button>
              <button type="submit" class="btn-confirmar" id="btn-submit">Confirmar Reserva</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- Leaflet JS para el mapa -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script src="{% static 'js/calendario.js' %}?v=8.0"></script>
<script>
// Debug: Verificar que el bot√≥n existe cuando se carga la p√°gina
document.addEventListener('DOMContentLoaded', function() {
    const btn = document.getElementById('abrir-google-maps');
    if (btn) {
        console.log('‚úÖ Bot√≥n Google Maps encontrado en DOM');
        console.log('Estado inicial:', btn.disabled ? 'DESHABILITADO' : 'HABILITADO');
    } else {
        console.error('‚ùå Bot√≥n Google Maps NO encontrado en DOM');
    }
});
</script>
{% endblock %}
