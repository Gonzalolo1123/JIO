{% extends 'jio_app/base_admin.html' %}
{% load static %}
{% load jio_filters %}

{% block title %}Juegos Inflables - JIO{% endblock %}

{% block content %}
<div class="panel-container">
  <div class="panel-header">
    <h1 class="panel-title">Juegos Inflables</h1>
  </div>

  <!-- Modal de edición -->
  <div id="modalEditJuego" class="modal" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Editar juego inflable</h2>
        <button class="modal-close" data-modal-close>&times;</button>
      </div>
      <form id="formEditJuego" class="form-grid" data-endpoint-base="/panel/juegos/">
        {% csrf_token %}
        <input type="hidden" name="juego_id" id="editJuegoId">
        <!-- Fila 1: Nombre, Categoría, Capacidad -->
        <label>
          Nombre
          <input type="text" name="nombre" id="editJuegoNombre" required>
        </label>
        <label>
          Categoría
          <select name="categoria" id="editJuegoCategoria" required>
            <option value="">Seleccionar categoría</option>
            {% for value, label in categoria_choices %}
            <option value="{{ value }}">{{ label }}</option>
            {% endfor %}
          </select>
        </label>
        <label>
          Capacidad (personas)
          <input type="number" name="capacidad_personas" id="editJuegoCapacidad" required min="1">
        </label>
        <!-- Fila 2: Largo, Ancho, Alto -->
        <label style="grid-column: 1 / -1; margin-bottom: 0.25rem; margin-top: 0.5rem;">
          <strong>Dimensiones (metros)</strong>
        </label>
        <label>
          Largo
          <input type="number" name="dimension_largo" id="editJuegoDimensionLargo" required min="0.1" step="0.1" placeholder="Ej: 5.5">
        </label>
        <label>
          Ancho
          <input type="number" name="dimension_ancho" id="editJuegoDimensionAncho" required min="0.1" step="0.1" placeholder="Ej: 3.0">
        </label>
        <label>
          Alto
          <input type="number" name="dimension_alto" id="editJuegoDimensionAlto" required min="0.1" step="0.1" placeholder="Ej: 2.5">
        </label>
        <!-- Fila 3: Peso máximo, Precio base, Descripción -->
        <label>
          Peso máximo (kg)
          <input type="number" name="peso_maximo" id="editJuegoPeso" required min="1">
        </label>
        <label>
          Precio base ($)
          <input type="number" name="precio_base" id="editJuegoPrecio" required min="1" step="1">
        </label>
        <label>
          Descripción
          <textarea name="descripcion" id="editJuegoDescripcion" rows="3"></textarea>
        </label>
        <!-- Fila 4: Imagen, Estado (3 columnas) -->
        <label>
          Imagen del juego
          <input type="file" name="foto" id="editJuegoFoto" accept="image/*">
          <small style="color:#7f8c8d;">Máximo 5MB. Formatos: JPG, PNG, GIF, WEBP</small>
        </label>
        <label>
          Estado
          <select name="estado" id="editJuegoEstado" required>
            {% for value, label in estado_choices %}
            <option value="{{ value }}">{{ label }}</option>
            {% endfor %}
          </select>
        </label>
        <label>
          <!-- Campo vacío para mantener estructura de 3 columnas -->
        </label>
        <div id="editJuegoFotoPreview" style="grid-column: 1 / -1; text-align: center; margin-top: 0.5rem;">
          <!-- Preview de la imagen existente/nueva -->
        </div>
        <label style="grid-column: 1 / -1;" id="editJuegoEliminarFotoContainer" style="display:none;">
          <input type="checkbox" name="eliminar_foto" id="editJuegoEliminarFoto" style="width:auto; margin-right:0.5rem;">
          <span>Eliminar imagen actual</span>
        </label>
        <div class="form-actions" style="grid-column: 1 / -1;">
          <button type="button" class="btn btn-secondary" data-modal-close>Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar</button>
        </div>
      </form>
    </div>
    <div class="modal-backdrop" data-modal-close></div>
  </div>

  <!-- Filtros de búsqueda -->
  <div class="form-card" id="juegosPage" data-juegos-base="/panel/juegos/">
    <form method="get" class="form-grid" style="grid-template-columns: 1fr 1fr 1fr auto;align-items: end;gap:1rem;">
      <input type="hidden" name="order_by" value="{{ order_by }}">
      <input type="hidden" name="direction" value="{{ direction }}">
      <label>Buscar
        <input type="text" name="q" value="{{ query }}" placeholder="Nombre, descripción o categoría">
      </label>
      <label>Categoría
        <select name="categoria">
          <option value="">Todas las categorías</option>
          {% for value, label in categoria_choices %}
          <option value="{{ value }}" {% if categoria_filter == value %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </label>
      <label>Estado
        <select name="estado">
          <option value="">Todos los estados</option>
          {% for value, label in estado_choices %}
          <option value="{{ value }}" {% if estado_filter == value %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </label>
      <button class="btn btn-secondary" type="submit">Filtrar</button>
    </form>
  </div>

  <!-- Lista de juegos -->
  <div class="form-card" style="overflow:auto;">
    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:.75rem;">
      <h2 class="panel-title" style="font-size:1.25rem; color:#2E7D32; margin:0;">Catálogo de Juegos</h2>
      <div class="actions-wrap" style="gap:.5rem;">
        <button type="button" id="btnOpenCreateJuego" class="btn btn-primary"><i class="fas fa-plus"></i> Agregar Juego</button>
      </div>
    </div>
    <table class="table">
      <thead>
        <tr>
          <th>
            <a href="?{% if query %}q={{ query }}&{% endif %}{% if categoria_filter %}categoria={{ categoria_filter }}&{% endif %}{% if estado_filter %}estado={{ estado_filter }}&{% endif %}order_by=id&direction={% if order_by == 'id' and direction == 'asc' %}desc{% else %}asc{% endif %}" class="sortable-header" style="text-decoration:none;color:inherit;display:flex;align-items:center;gap:0.5rem;">
              ID
              {% if order_by == 'id' %}
                <i class="fas fa-arrow-{% if direction == 'asc' %}up{% else %}down{% endif %}" style="font-size:0.75rem;"></i>
              {% else %}
                <i class="fas fa-sort" style="font-size:0.75rem;color:#bbb;"></i>
              {% endif %}
            </a>
          </th>
          <th>Foto</th>
          <th>
            <a href="?{% if query %}q={{ query }}&{% endif %}{% if categoria_filter %}categoria={{ categoria_filter }}&{% endif %}{% if estado_filter %}estado={{ estado_filter }}&{% endif %}order_by=nombre&direction={% if order_by == 'nombre' and direction == 'asc' %}desc{% else %}asc{% endif %}" class="sortable-header" style="text-decoration:none;color:inherit;display:flex;align-items:center;gap:0.5rem;">
              Nombre
              {% if order_by == 'nombre' %}
                <i class="fas fa-arrow-{% if direction == 'asc' %}up{% else %}down{% endif %}" style="font-size:0.75rem;"></i>
              {% else %}
                <i class="fas fa-sort" style="font-size:0.75rem;color:#bbb;"></i>
              {% endif %}
            </a>
          </th>
          <th>
            <a href="?{% if query %}q={{ query }}&{% endif %}{% if categoria_filter %}categoria={{ categoria_filter }}&{% endif %}{% if estado_filter %}estado={{ estado_filter }}&{% endif %}order_by=categoria&direction={% if order_by == 'categoria' and direction == 'asc' %}desc{% else %}asc{% endif %}" class="sortable-header" style="text-decoration:none;color:inherit;display:flex;align-items:center;gap:0.5rem;">
              Categoría
              {% if order_by == 'categoria' %}
                <i class="fas fa-arrow-{% if direction == 'asc' %}up{% else %}down{% endif %}" style="font-size:0.75rem;"></i>
              {% else %}
                <i class="fas fa-sort" style="font-size:0.75rem;color:#bbb;"></i>
              {% endif %}
            </a>
          </th>
          <th>Dimensiones</th>
          <th>
            <a href="?{% if query %}q={{ query }}&{% endif %}{% if categoria_filter %}categoria={{ categoria_filter }}&{% endif %}{% if estado_filter %}estado={{ estado_filter }}&{% endif %}order_by=capacidad_personas&direction={% if order_by == 'capacidad_personas' and direction == 'asc' %}desc{% else %}asc{% endif %}" class="sortable-header" style="text-decoration:none;color:inherit;display:flex;align-items:center;gap:0.5rem;">
              Capacidad
              {% if order_by == 'capacidad_personas' %}
                <i class="fas fa-arrow-{% if direction == 'asc' %}up{% else %}down{% endif %}" style="font-size:0.75rem;"></i>
              {% else %}
                <i class="fas fa-sort" style="font-size:0.75rem;color:#bbb;"></i>
              {% endif %}
            </a>
          </th>
          <th>
            <a href="?{% if query %}q={{ query }}&{% endif %}{% if categoria_filter %}categoria={{ categoria_filter }}&{% endif %}{% if estado_filter %}estado={{ estado_filter }}&{% endif %}order_by=precio_base&direction={% if order_by == 'precio_base' and direction == 'asc' %}desc{% else %}asc{% endif %}" class="sortable-header" style="text-decoration:none;color:inherit;display:flex;align-items:center;gap:0.5rem;">
              Precio
              {% if order_by == 'precio_base' %}
                <i class="fas fa-arrow-{% if direction == 'asc' %}up{% else %}down{% endif %}" style="font-size:0.75rem;"></i>
              {% else %}
                <i class="fas fa-sort" style="font-size:0.75rem;color:#bbb;"></i>
              {% endif %}
            </a>
          </th>
          <th>
            <a href="?{% if query %}q={{ query }}&{% endif %}{% if categoria_filter %}categoria={{ categoria_filter }}&{% endif %}{% if estado_filter %}estado={{ estado_filter }}&{% endif %}order_by=estado&direction={% if order_by == 'estado' and direction == 'asc' %}desc{% else %}asc{% endif %}" class="sortable-header" style="text-decoration:none;color:inherit;display:flex;align-items:center;gap:0.5rem;">
              Estado
              {% if order_by == 'estado' %}
                <i class="fas fa-arrow-{% if direction == 'asc' %}up{% else %}down{% endif %}" style="font-size:0.75rem;"></i>
              {% else %}
                <i class="fas fa-sort" style="font-size:0.75rem;color:#bbb;"></i>
              {% endif %}
            </a>
          </th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for juego in juegos %}
        <tr>
          <td>{{ juego.id }}</td>
          <td>
            {% if juego.foto %}
              <img src="{{ juego.foto.url }}" alt="{{ juego.nombre }}" style="width:60px;height:60px;object-fit:cover;border-radius:8px;box-shadow:0 2px 5px rgba(0,0,0,0.1);">
            {% else %}
              <div style="width:60px;height:60px;background:#f0f0f0;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#999;font-size:1.5rem;">
                <i class="fas fa-image"></i>
              </div>
            {% endif %}
          </td>
          <td>
            <strong>{{ juego.nombre }}</strong>
            {% if juego.descripcion %}
              <br><small style="color:#666;">{{ juego.descripcion|truncatechars:50 }}</small>
            {% endif %}
          </td>
          <td>{{ juego.get_categoria_display }}</td>
          <td>{{ juego.dimensiones }}</td>
          <td>{{ juego.capacidad_personas }} {% if juego.capacidad_personas == 1 %}persona{% else %}personas{% endif %}</td>
          <td>{{ juego.precio_base|precio_chileno }}</td>
          <td>
            <span class="status-badge status-{{ juego.estado }}">
              {{ juego.get_estado_display }}
            </span>
          </td>
          <td style="white-space:nowrap;">
            <button class="btn btn-secondary" data-edit-juego="{{ juego.id }}">Editar</button>
            <button class="btn btn-danger" data-delete-juego="{{ juego.id }}">Eliminar</button>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="9">No hay juegos que coincidan con los filtros.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  
  <!-- Modal de creación -->
  <div id="modalCreateJuego" class="modal" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Nuevo juego inflable</h2>
        <button class="modal-close" data-modal-close>&times;</button>
      </div>
      <form id="formCreateJuego" class="form-grid" data-endpoint="{% url 'jio_app:juego_create_json' %}">
        {% csrf_token %}
        <!-- Fila 1: Nombre, Categoría, Capacidad -->
        <label>
          Nombre
          <input type="text" name="nombre" required>
        </label>
        <label>
          Categoría
          <select name="categoria" required>
            <option value="">Seleccionar categoría</option>
            {% for value, label in categoria_choices %}
            <option value="{{ value }}">{{ label }}</option>
            {% endfor %}
          </select>
        </label>
        <label>
          Capacidad (personas)
          <input type="number" name="capacidad_personas" required min="1">
        </label>
        <!-- Fila 2: Largo, Ancho, Alto -->
        <label style="grid-column: 1 / -1; margin-bottom: 0.25rem; margin-top: 0.5rem;">
          <strong>Dimensiones (metros)</strong>
        </label>
        <label>
          Largo
          <input type="number" name="dimension_largo" id="createJuegoDimensionLargo" required min="0.1" step="0.1" placeholder="Ej: 5.5">
        </label>
        <label>
          Ancho
          <input type="number" name="dimension_ancho" id="createJuegoDimensionAncho" required min="0.1" step="0.1" placeholder="Ej: 3.0">
        </label>
        <label>
          Alto
          <input type="number" name="dimension_alto" id="createJuegoDimensionAlto" required min="0.1" step="0.1" placeholder="Ej: 2.5">
        </label>
        <!-- Fila 3: Peso máximo, Precio base, Descripción -->
        <label>
          Peso máximo (kg)
          <input type="number" name="peso_maximo" required min="1">
        </label>
        <label>
          Precio base ($)
          <input type="number" name="precio_base" required min="1" step="1">
        </label>
        <label>
          Descripción
          <textarea name="descripcion" rows="3"></textarea>
        </label>
        <!-- Fila 4: Imagen, Estado (3 columnas) -->
        <label>
          Imagen del juego
          <input type="file" name="foto" id="createJuegoFoto" accept="image/*">
          <small style="color:#7f8c8d;">Máximo 5MB. Formatos: JPG, PNG, GIF, WEBP</small>
        </label>
        <label>
          Estado
          <select name="estado" required>
            {% for value, label in estado_choices %}
            <option value="{{ value }}" {% if value == 'disponible' %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
        </label>
        <label>
          <!-- Campo vacío para mantener estructura de 3 columnas -->
        </label>
        <div id="createJuegoFotoPreview" style="grid-column: 1 / -1; text-align: center; margin-top: 0.5rem;">
          <!-- Preview de la imagen -->
        </div>
        <div class="form-actions" style="grid-column: 1 / -1;">
          <button type="button" class="btn btn-secondary" data-modal-close>Cancelar</button>
          <button type="submit" class="btn btn-primary">Crear</button>
        </div>
      </form>
    </div>
    <div class="modal-backdrop" data-modal-close></div>
  </div>
  
  {% block extra_scripts %}
  <script src="{% static 'js/validaciones.js' %}"></script>
  <script src="{% static 'js/juegos_list.js' %}"></script>
  {% endblock %}
</div>
{% endblock %}
